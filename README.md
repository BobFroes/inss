<h3>Microsservi&ccedil;o INSS</h3>
<p style="text-align: justify;">Se voc&ecirc; &eacute; ou j&aacute; foi contratado em regime de CLT, pode ter percebido em seu contra-cheque alguns descontos de inss (seguridade social), irf (imposto de renda), sal&aacute;rio familia etc. Este projeto &eacute; um microsservi&ccedil;o respons&aacute;vel por calcular os descontos de inss de uma determinada lista de funcion&aacute;rios com seus respectivos sal&aacute;rios. A tabela a seguir ser&aacute; nossa refer&ecirc;ncia para os c&aacute;lculos.</p>
<table style="width: 100%;">
    <tbody>
        <tr>
            <td style="width: 50.0000%;"><span style='color: rgb(36, 41, 46); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;'><strong>Sal&aacute;rio de contribui&ccedil;&atilde;o 2021</strong></span><strong><br></strong></td>
            <td style="width: 50.0000%;"><strong>Alíquota</strong></td>
        </tr>
        <tr>
            <td style="width: 50.0000%;"><span style='color: rgb(36, 41, 46); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;'>At&eacute; R$ 1.100</span></td>
            <td style="width: 50.0000%;">7,50%</td>
        </tr>
        <tr>
            <td style="width: 50.0000%;"><span style='color: rgb(36, 41, 46); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;'>De R$ 1.100,01 a R$ 2.203,48</span></td>
            <td style="width: 50.0000%;">9,00%</td>
        </tr>
        <tr>
            <td style="width: 50.0000%;"><span style='color: rgb(36, 41, 46); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;'>De R$ 2.203,49 at&eacute; R$ 3.305,22</span></td>
            <td style="width: 50.0000%;">12,00%</td>
        </tr>
        <tr>
            <td style="width: 50.0000%;"><span style='color: rgb(36, 41, 46); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;'>De R$ 3.305,23 at&eacute; R$ 6.433,57</span></td>
            <td style="width: 50.0000%;">14,00%</td>
        </tr>
    </tbody>
</table>
<hr>
<p style="box-sizing: border-box; font-family: Lato; color: rgb(48, 69, 92); font-size: 16px; line-height: 28px; margin-top: 0px; margin-bottom: 1rem; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">Vejamos como fica o c&aacute;lculo para um sal&aacute;rio de R$ 3.000,00, que se encontra na 3&ordf; faixa:</p>
<ul style="box-sizing: border-box; font-family: Lato; color: rgb(48, 69, 92); margin-top: 0px; margin-bottom: 1rem; padding-left: 25px; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;">
    <li style="box-sizing: border-box; font-family: Lato; color: rgb(48, 69, 92); font-size: 16px;"><strong style="box-sizing: border-box; font-weight: bolder;">1&ordf; faixa salarial</strong>: 1.100,00 x 0,075 = 82,50</li>
    <li style="box-sizing: border-box; font-family: Lato; color: rgb(48, 69, 92); font-size: 16px;"><strong style="box-sizing: border-box; font-weight: bolder;">2&ordf; faixa salarial</strong>: (2.203,48 &ndash; 1.100,00) x 0,09 = 99,31</li>
    <li style="box-sizing: border-box; font-family: Lato; color: rgb(48, 69, 92); font-size: 16px;"><strong style="box-sizing: border-box; font-weight: bolder;">Faixa que atinge o sal&aacute;rio</strong>: (3.000,00 &ndash; 2.203,48) x 0,12 = 95,58</li>
    <li style="box-sizing: border-box; font-family: Lato; color: rgb(48, 69, 92); font-size: 16px;"><strong style="box-sizing: border-box; font-weight: bolder;">Total a recolher</strong>: 95,58 + 99,31 + 82,50 = 277,39</li>
</ul>
<p><span style="color: rgb(48, 69, 92); font-family: Lato; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Com este resultado &eacute; poss&iacute;vel calcular a al&iacute;quota efetiva que se encontra em cerca de 9,25% (277,39 &divide; 3.000,00).</span></p>

<h3>Comunicação entre microsserviços</h3>

![alt-text](https://github.com/BobFroes/inss/blob/325ddc3bda4123be28c66de782bddc55eb244ac1/MSS.png?raw=true)

<p dir="ltr" style="line-height:1.38;text-align: justify;margin-top:0pt;margin-bottom:0pt;">O microsserviço RH irá produzir uma mensagem contendo a lista de funcionários com seus salários no tópico <i>inss-calculate-request</i>. O kafka ao receber a mensagem vai dizer: “Hey! Chegou mensagem aqui no tópico <i>inss-calculate-request</i>, existe alguém que tenha interesse em <strong>consumir</strong>?”.  Como o microsserviço INSS assina o tópico de requisição, ele pegará a mensagem, processará e logo em seguida, <strong>produzirá</strong> uma nova lista de funcionários com seus salários,  discontos e percentuais no tópico de resposta  <i>inss-calculate-reply</i>. E lá vai o kafka novamente: “Opa! Chegou mensagem aqui no tópico <i>inss-calculate-reply</i>, existe alguém que tenha interesse em <strong>consumir</strong>?”. Eu! Responde o RH MS que assina o tópico de resposta e consumirá a lista de funcionários que foi <strong>produzida</strong> pelo microsserviço INSS.</p>

<p><strong>Mensagem de requisição produzida pelo RH MS</strong></p>


	{
	   "year": "2021", 
       "employees": [{
		   "id": "fa07de98-1d78-4b8a-9fb2-0308474d3c35",
		   "salary": 1100
	   }, {
		   "id": "7c1e1d02-0a0b-41c7-b5f1-929ec01e04d7",
		   "salary": 2000
	   }, {
		   "id": "df32e121-03a7-4af4-b5c5-02ffc08b3db5",
		   "salary": 3000
	   }, {
		   "id": "af32e121-03a7-4af4-b5c5-02ffc08b3db3",
		   "salary": 5000
	   }, {
		   "id": "f048fe759-02ba-4e25-b19f-4c4c882d4d2",
		   "salary": 7000
	   }]
    }

<p><strong>Mensagem de resposta produzida pelo INSS MS</strong></p>

	{
	   "year": "2021", 
       "employees": [{
		   "id": "fa07de98-1d78-4b8a-9fb2-0308474d3c35",
		   "salary": 1100
		   "discount": 82.50
		   "percent": "7.50%"
	   }, {
		   "id": "7c1e1d02-0a0b-41c7-b5f1-929ec01e04d7",
		   "salary": 2000
		   "discount": 163.50
		   "percent": "8.18%"
	   }, {
		   "id": "df32e121-03a7-4af4-b5c5-02ffc08b3db5",
		   "salary": 3000
		   "discount": 277.39
		   "percent": "9.25%"
	   }, {
		   "id": "af32e121-03a7-4af4-b5c5-02ffc08b3db3",
		   "salary": 5000
		   "discount": 551.29
		   "percent": "11.03%"
	   }, {
		   "id": "f048fe759-02ba-4e25-b19f-4c4c882d4d2",
		   "salary": 7000
		   "discount": 751.99
		   "percent": "TETO"
	   }]
    }



<h3>Bora testar!</h3>

<p>Para executar e testar o projeto (Intellij IDE), antes precisaremos executar via terminal (utilizo o linux) os containers docker do kafka e postgres localizados na pasta resources do projeto.</p>

	docker-compose -f kafka-docker-compose.yml up -d
	docker-compose -f postgres-docker-compose.yml up -d
<p><span style='color: rgb(36, 41, 46); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;'>Crie o banco de dados <em>db_inss</em> e logo em seguida execute o projeto.</span></p>
<p>Utilizando o Postman, fa&ccedil;a uma requisi&ccedil;&atilde;o do tipo POST <em>http://localhost:8084/api/inss</em>, passando no corpo o objeto json a seguir:</p>

	{
	   "year": "2021",
	   "until": 1100,
	   "percent": 7.50,
	   "fromSecond": 1100.01,
	   "untilSecond": 2203.48,
	   "percentSecond": 9,
	   "fromThird": 2203.49,
	   "untilThird": 3305.22,
	   "percentThird": 12,
	   "fromFourth": 3305.23,
	   "untilFourth": 6433.57,
	   "percentFourth": 14
	}
    
<p>&Eacute; esperado que retorne um status <em>201 created</em> e pronto, nossa tabela de inss estar&aacute; populada para os c&aacute;lculos!</p>

<p>Abrindo um novo terminal, vamos entrar no container kafka digitando o comando a seguir:</p>

	docker exec -it image_name bash
<p>Vamos preparar nosso <strong>consumidor</strong> do microsserviço Rh que ir&aacute; escutar a requisi&ccedil;&atilde;o no t&oacute;pico &quot;inss-calculate-reply&quot;, digitando o seguinte comando e aperte enter:</p>  

	kafka-console-consumer --bootstrap-server localhost:9092 --topic inss-calculate-reply
<p>Pronto, nosso consumidor está na escuta! No mesmo terminal, clique com o bot&atilde;o direito do mouse e selecione a op&ccedil;&atilde;o new tab, onde aparecer&aacute; uma nova aba. Neste momento o microsserviço Rh <strong>produzirá</strong>strong> uma mensagem com a lista de funcion&aacute;rios onde queremos que sejam calculados os descontos de inss. Para isso, vamos preparar nosso <strong>produtor</strong> que enviará nossa mensagem para o tópico "inss-calculate-request", digitando o seguinte comando e aperte enter:</p>

	 kafka-console-producer --broker-list localhost:9092 --topic inss-calculate-request
<p>No cursor do nosso producer (>) informe a lista de funcionários com seus respectivos salários e digite enter:</p>

	 {"year": "2021", "employees": [{"id": "fa07de98-1d78-4b8a-9fb2-0308474d3c35","salary": 1100}, {"id": "7c1e1d02-0a0b-41c7-b5f1-929ec01e04d7","salary": 2000}, {"id": "df32e121-03a7-4af4-b5c5-02ffc08b3db5","salary": 3000}, {"id": "af32e121-03a7-4af4-b5c5-02ffc08b3db3","salary": 5000}, {"id": "f048fe759-02ba-4e25-b19f-4c4c882d4d2","salary": 7000}]}
<p>Voltando para a aba do nosso <strong>consumidor</strong>, veremos o resultado esperado com os devidos c&aacute;lculos. Nosso microsserviço Rh escutou no tópico "inss-calculate-reply", recebeu sua lista de funcionários com os descontos e percentuais.</p>

![alt-text](https://github.com/BobFroes/inss/blob/719743758ff26b9adb55ba199044ccda8df9b36d/kafka.gif?raw=true)
    
<p>Foram desenvolvidos testes de unidade e de integra&ccedil;&atilde;o para este projeto</p>
<ul>
    <li>Teste de unidade utilizando Mockito</li>
    <li>Teste de integra&ccedil;&atilde;o utilizando Test Container (PostgreSQL) e @EmbebbedleKafka</li>
</ul>
